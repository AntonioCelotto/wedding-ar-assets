<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>NDA Experience – AR</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial; }
    body { background: linear-gradient(#ffd6e3, #f7b2c7); }

    .overlay {
      position: fixed; inset: 0;
      display:flex; align-items:center; justify-content:center;
      z-index: 20;
      padding: 18px;
      background: radial-gradient(circle at 50% 25%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%),
                  linear-gradient(#ffd6e3, #f7b2c7);
    }
    .card {
      width: min(560px, 100%);
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(255,255,255,.6);
      border-radius: 22px;
      padding: 18px;
      text-align:center;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }
    .title { margin: 2px 0 6px; font-size: 20px; font-weight: 900; color:#2b1220; }
    .sub { margin: 0 0 12px; font-size: 14px; color: rgba(43,18,32,.75); line-height: 1.4; }

    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn {
      border: none; border-radius: 999px;
      padding: 12px 18px;
      font-weight: 900;
      cursor: pointer;
      background: rgba(255,255,255,.95);
      color: #2b1220;
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
    }
    .btn.primary { background: #ff4d88; color: white; }

    .pill {
      position: fixed; top: 10px; left: 10px; right: 10px;
      display:flex; justify-content:space-between; gap:10px;
      z-index: 30;
      pointer-events:none;
    }
    .badge {
      pointer-events:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.8);
      color: rgba(43,18,32,.85);
      font-size: 13px;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
    }
    .badge strong { font-weight: 900; }
    .hidden { display:none !important; }
  </style>
</head>

<body>

<div class="pill">
  <div class="badge" id="status"><strong>AR</strong> Pronto ✨</div>
  <div class="badge hidden" id="page">Pagina: —</div>
</div>

<div class="overlay" id="ui">
  <div class="card">
    <div class="title" id="uiTitle">NDA Experience</div>
    <div class="sub" id="uiSub">Tocca “Avvia esperienza”, consenti la fotocamera, poi inquadra l’immagine.</div>
    <div class="row">
      <button class="btn primary" id="startBtn">Avvia esperienza</button>
      <button class="btn" id="helpBtn">Come funziona</button>
    </div>
    <div class="sub" style="margin-top:10px;font-size:12.5px;">
      Consiglio: luce buona + immagine ferma 1–2 sec.
    </div>
  </div>
</div>

<!-- Scena: imageTargetSrc lo settiamo via JS leggendo config.json -->
<a-scene
  embedded
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">
  <a-assets id="assetsRoot"></a-assets>
  <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>
</a-scene>

<script>
  const ui = document.getElementById("ui");
  const startBtn = document.getElementById("startBtn");
  const helpBtn = document.getElementById("helpBtn");
  const status = document.getElementById("status");
  const page = document.getElementById("page");

  const uiTitle = document.getElementById("uiTitle");
  const uiSub = document.getElementById("uiSub");

  const scene = document.querySelector("a-scene");
  const assetsRoot = document.getElementById("assetsRoot");

  let cfg = null;
  let targets = []; // { name, type, src, el }
  let activeIdx = null;

  function setStatus(text){ status.textContent = "AR " + text; }
  function showPage(name){
    page.classList.remove("hidden");
    page.textContent = "Pagina: " + name;
  }
  function hidePage(){ page.classList.add("hidden"); page.textContent = "Pagina: —"; }

  function stopAll(){
    targets.forEach(t => {
      if (t.type === "video" && t.el) {
        try { t.el.pause(); t.el.currentTime = 0; } catch(e){}
      }
    });
  }

  async function unlockVideos() {
    for (const t of targets) {
      if (t.type !== "video" || !t.el) continue;
      try {
        t.el.muted = true;
        t.el.playsInline = true;
        t.el.setAttribute("playsinline", "");
        t.el.setAttribute("webkit-playsinline", "");
        await t.el.play();
        t.el.pause();
        t.el.currentTime = 0;
      } catch(e) {}
    }
  }

  // Bottone audio (gesture separata)
  const audioBtn = document.createElement("button");
  audioBtn.className = "btn";
  audioBtn.textContent = "Attiva audio";
  audioBtn.style.position = "fixed";
  audioBtn.style.bottom = "14px";
  audioBtn.style.left = "50%";
  audioBtn.style.transform = "translateX(-50%)";
  audioBtn.style.zIndex = "40";
  audioBtn.style.display = "none";
  document.body.appendChild(audioBtn);

  audioBtn.addEventListener("click", async () => {
    if (activeIdx === null) return;
    const t = targets[activeIdx];
    if (!t || t.type !== "video" || !t.el) return;

    try {
      t.el.muted = false;
      await t.el.play();
      audioBtn.textContent = "Audio attivo";
      setTimeout(() => audioBtn.style.display = "none", 800);
    } catch(e){
      t.el.muted = true;
      audioBtn.textContent = "Audio non disponibile";
      setTimeout(() => audioBtn.style.display = "none", 1200);
    }
  });

  function helpText(){
    const title = (cfg && cfg.title) ? cfg.title : "NDA Experience";
    return (
      `1) Tocca 'Avvia esperienza'\n` +
      `2) Consenti la fotocamera\n` +
      `3) Inquadra l’immagine AR\n\n` +
      `Suggerimenti:\n- Luce buona\n- Tieni l’immagine ferma 1–2 secondi\n- Se non parte subito, avvicina/allontana leggermente\n\n` +
      `${title}`
    );
  }

  helpBtn.addEventListener("click", () => alert(helpText()));

  async function loadConfig() {
    const res = await fetch("./config.json", { cache: "no-store" });
    if (!res.ok) throw new Error("config.json non trovato");
    cfg = await res.json();

    // UI title/sub
    uiTitle.textContent = cfg.title || "NDA Experience";
    uiSub.textContent = cfg.subtitle || "Tocca “Avvia esperienza”, consenti la fotocamera, poi inquadra l’immagine.";

    // Set mindar-image attribute
    const mindSrc = cfg.targetsMind || "targets.mind";
    scene.setAttribute("mindar-image", `imageTargetSrc: ${mindSrc}; autoStart: false; uiLoading: no; uiError: no;`);

    // Build assets and target entities
    targets = (cfg.targets || []).map((t, i) => ({
      name: t.name || `Target ${i+1}`,
      type: t.type || "video",
      src: t.src,
      el: null
    }));

    // Create assets (video)
    targets.forEach((t, i) => {
      if (t.type === "video") {
        const v = document.createElement("video");
        v.setAttribute("id", `v${i}`);
        v.setAttribute("crossorigin", "anonymous");
        v.setAttribute("preload", "auto");
        v.setAttribute("playsinline", "");
        v.setAttribute("webkit-playsinline", "");
        v.setAttribute("muted", "");
        v.src = t.src;
        assetsRoot.appendChild(v);
        t.el = v;
      }
    });

    // Create entities for each target
    targets.forEach((t, i) => {
      const ent = document.createElement("a-entity");
      ent.setAttribute("mindar-image-target", `targetIndex: ${i}`);

      const plane = document.createElement("a-plane");
      plane.setAttribute("width", "1");
      plane.setAttribute("height", "1");

      if (t.type === "video") {
        plane.setAttribute("material", `shader: flat; src: #v${i}`);
      } else {
        // per future estensioni (image, gltf, ecc.)
        plane.setAttribute("material", `shader: flat; color: #FFFFFF`);
      }

      ent.appendChild(plane);
      scene.appendChild(ent);

      // Events
      ent.addEventListener("targetFound", async () => {
        activeIdx = i;
        showPage(t.name);
        setStatus("Contenuto attivo ✨");
        stopAll();

        if (t.type === "video" && t.el) {
          try {
            t.el.muted = true; // autoplay safe
            await t.el.play();
            audioBtn.textContent = "Attiva audio";
            audioBtn.style.display = "inline-block";
          } catch(e){
            setStatus("Video non avviato");
          }
        }
      });

      ent.addEventListener("targetLost", () => {
        if (activeIdx === i) {
          activeIdx = null;
          hidePage();
          setStatus("Inquadra l’immagine ✨");
          audioBtn.style.display = "none";
          stopAll();
        }
      });
    });
  }

  startBtn.addEventListener("click", async () => {
    setStatus("Avvio fotocamera…");
    try {
      // load + unlock with user gesture
      targets.forEach(t => { if (t.type === "video" && t.el) { try { t.el.load(); } catch(e){} } });
      await unlockVideos();

      await scene.systems["mindar-image-system"].start();
      ui.style.display = "none";
      setStatus("Inquadra l’immagine ✨");
    } catch(e){
      setStatus("Errore fotocamera");
      alert("Non riesco ad avviare la fotocamera. Controlla permessi del browser e riprova.");
    }
  });

  (async function init(){
    try {
      setStatus("Carico esperienza…");
      await loadConfig();
      setStatus("Pronto ✨");
    } catch(e){
      setStatus("Errore config");
      console.error(e);
      alert("Config non trovata o non valida. Verifica che 'config.json' sia presente nella stessa cartella dell'index.");
    }
  })();
</script>

</body>
</html>

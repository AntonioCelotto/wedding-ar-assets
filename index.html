<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Wedding AR â€“ Standalone</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root{
      --pink1:#ffe3ea;
      --pink2:#ffc7d4;
      --pink3:#ff7aa6;
      --text:#2a1b22;
      --glass: rgba(255,255,255,.86);
      --shadow: 0 18px 45px rgba(0,0,0,.22);
      --radius: 20px;
    }

    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, var(--pink1), var(--pink2));
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      overflow: hidden;
    }

    /* Overlay start */
    .overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: radial-gradient(circle at 40% 10%, rgba(255,255,255,.55), rgba(255,255,255,0) 55%),
                  linear-gradient(180deg, var(--pink1), var(--pink2));
      z-index: 50;
    }

    .card {
      width: min(520px, 100%);
      background: var(--glass);
      border: 1px solid rgba(255,255,255,.7);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px 20px 18px;
      text-align: center;
      color: var(--text);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .card h2{
      margin: 0 0 8px;
      font-size: 20px;
      letter-spacing: .2px;
    }
    .card p{
      margin: 0 0 14px;
      font-size: 14px;
      opacity: .85;
      line-height: 1.35;
    }

    .btn {
      width: min(260px, 92vw);
      border: none;
      border-radius: 999px;
      padding: 14px 18px;
      font-weight: 800;
      cursor: pointer;
      background: white;
      color: #1c0f15;
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }
    .btn:active{ transform: translateY(1px); }

    /* Floating audio button (always above AR) */
    #audioBtn {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + env(safe-area-inset-bottom));
      width: min(240px, 92vw);
      padding: 14px 18px;
      border-radius: 999px;
      border: none;
      font-weight: 900;
      cursor: pointer;
      background: var(--pink3);
      color: white;
      box-shadow: 0 16px 40px rgba(0,0,0,.20);
      z-index: 9999;
      display: none;          /* mostrato solo quando serve */
      opacity: 1;
      pointer-events: auto;
    }

    /* Small status pill */
    #status {
      position: fixed;
      top: calc(12px + env(safe-area-inset-top));
      left: 12px;
      right: 12px;
      z-index: 9999;
      display: flex;
      justify-content: center;
      pointer-events: none;
    }
    #status span{
      pointer-events: auto;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(255,255,255,.75);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      box-shadow: 0 12px 26px rgba(0,0,0,.12);
      color: #2a1b22;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
  </style>
</head>

<body>

  <!-- Status -->
  <div id="status"><span id="statusText">Pronto âœ¨</span></div>

  <!-- Start overlay -->
  <div class="overlay" id="ui">
    <div class="card">
      <h2>Wedding AR Experience</h2>
      <p>
        Tocca <b>Avvia esperienza</b>, consenti la fotocamera<br>
        e inquadra una pagina AR della rivista ðŸ’—
      </p>
      <button class="btn" id="startBtn">Avvia esperienza</button>
    </div>
  </div>

  <!-- Floating audio button -->
  <button id="audioBtn">Attiva audio</button>

  <!-- AR Scene -->
  <a-scene
    mindar-image="imageTargetSrc: targets.mind; autoStart: false; uiLoading: no; uiError: no;"
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true, physicallyCorrectLights: true"
  >
    <a-assets>
      <!-- Nota: su Android l'audio parte SOLO dopo tap -> qui li lasciamo muted.
           Poi li sblocchiamo col bottone. -->
      <video id="v1"
        src="https://video.wixstatic.com/video/047e10_cbfeceaf5a244d839a6d4fdefa666bda/1080p/mp4/file.mp4"
        preload="auto" playsinline webkit-playsinline muted></video>

      <video id="v2"
        src="https://video.wixstatic.com/video/047e10_5741e3a04b2f45c1ab8efe8450641163/1080p/mp4/file.mp4"
        preload="auto" playsinline webkit-playsinline muted></video>

      <video id="v3"
        src="https://video.wixstatic.com/video/047e10_68bb22b5292a4047a7ec9bedea327b65/1080p/mp4/file.mp4"
        preload="auto" playsinline webkit-playsinline muted></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-plane width="1" height="1" material="shader: flat; src: #v1"></a-plane>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 1">
      <a-plane width="1" height="1" material="shader: flat; src: #v2"></a-plane>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 2">
      <a-plane width="1" height="1" material="shader: flat; src: #v3"></a-plane>
    </a-entity>
  </a-scene>

  <script>
    const ui = document.getElementById("ui");
    const startBtn = document.getElementById("startBtn");
    const audioBtn = document.getElementById("audioBtn");
    const statusText = document.getElementById("statusText");

    const sceneEl = document.querySelector("a-scene");

    const vids = [
      document.getElementById("v1"),
      document.getElementById("v2"),
      document.getElementById("v3"),
    ];

    let activeIndex = null;

    function pauseAll(reset=false){
      vids.forEach(v => {
        try { v.pause(); } catch(e){}
        if(reset){
          try { v.currentTime = 0; } catch(e){}
        }
      });
    }

    async function safePlay(i){
      const v = vids[i];
      try {
        await v.play();
      } catch(e) {
        // se fallisce, rimane fermo: l'utente potrÃ  sbloccarlo con tap audio
      }
    }

    function showAudioButton(){
      audioBtn.textContent = "Attiva audio";
      audioBtn.style.display = "inline-block";
      audioBtn.style.opacity = "1";
      audioBtn.style.pointerEvents = "auto";
    }

    function hideAudioButton(){
      audioBtn.style.display = "none";
    }

    // START AR (gesture utente -> camera permission)
    startBtn.addEventListener("click", async () => {
      statusText.textContent = "Avvio fotocameraâ€¦";
      // pre-warm
      try { vids.forEach(v => v.load()); } catch(e){}

      try {
        await sceneEl.systems["mindar-image-system"].start();
        ui.style.display = "none";
        statusText.textContent = "Inquadra una pagina AR";
      } catch(e) {
        statusText.textContent = "Errore fotocamera";
        alert("Non riesco ad avviare la fotocamera. Controlla i permessi e riprova.");
      }
    });

    // Target events
    document.querySelectorAll("[mindar-image-target]").forEach((el, i) => {
      el.addEventListener("targetFound", async () => {
        activeIndex = i;

        // Avvio video in modalitÃ  safe (muted su Android)
        pauseAll(true);
        vids[i].muted = true; // importantissimo per autoplay
        statusText.textContent = "Pagina riconosciuta âœ¨";
        showAudioButton();    // su Android serve sempre

        await safePlay(i);
      });

      el.addEventListener("targetLost", () => {
        if(activeIndex === i){
          activeIndex = null;
          statusText.textContent = "Inquadra una pagina AR";
          hideAudioButton();
          pauseAll(false);
        }
      });
    });

    // AUDIO UNLOCK (gesture utente)
    audioBtn.addEventListener("click", async () => {
      if(activeIndex === null) return;

      const v = vids[activeIndex];

      // sblocca audio + riparti
      try {
        v.muted = false;
        await v.play();
        audioBtn.textContent = "Audio attivo âœ…";
        statusText.textContent = "Audio attivo";
      } catch(e) {
        // fallback: prova a ripartire da zero
        try {
          v.muted = false;
          v.currentTime = 0;
          await v.play();
          audioBtn.textContent = "Audio attivo âœ…";
          statusText.textContent = "Audio attivo";
        } catch(e2) {
          alert("Audio bloccato: riprova toccando ancora 'Attiva audio'.");
        }
      }
    });

    // Init
    statusText.textContent = "Pronto âœ¨";
  </script>
</body>
</html>

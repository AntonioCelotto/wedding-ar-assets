<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Wedding AR – Standalone</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial; }
    body { background: linear-gradient(#ffd6e3, #f7b2c7); }

    .overlay {
      position: fixed; inset: 0;
      display:flex; align-items:center; justify-content:center;
      z-index: 20;
      padding: 18px;
      background: radial-gradient(circle at 50% 25%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%),
                  linear-gradient(#ffd6e3, #f7b2c7);
    }
    .card {
      width: min(520px, 100%);
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(255,255,255,.6);
      border-radius: 22px;
      padding: 18px;
      text-align:center;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }
    .title { margin: 2px 0 6px; font-size: 20px; font-weight: 800; color:#2b1220; }
    .sub { margin: 0 0 12px; font-size: 14px; color: rgba(43,18,32,.75); line-height: 1.4; }

    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn {
      border: none; border-radius: 999px;
      padding: 12px 18px;
      font-weight: 800;
      cursor: pointer;
      background: rgba(255,255,255,.95);
      color: #2b1220;
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
    }
    .btn.primary { background: #ff4d88; color: white; }
    .pill {
      position: fixed; top: 10px; left: 10px; right: 10px;
      display:flex; justify-content:space-between; gap:10px;
      z-index: 30;
      pointer-events:none;
    }
    .badge {
      pointer-events:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.8);
      color: rgba(43,18,32,.85);
      font-size: 13px;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
    }
    .badge strong { font-weight: 900; }
    .hidden { display:none !important; }
  </style>
</head>

<body>

<div class="pill">
  <div class="badge" id="status"><strong>AR</strong> Pronto ✨</div>
  <div class="badge hidden" id="page">Pagina: —</div>
</div>

<div class="overlay" id="ui">
  <div class="card">
    <div class="title" id="uiTitle">Wedding AR Experience</div>
    <div class="sub" id="uiSub">Tocca “Avvia esperienza”, consenti la fotocamera, poi inquadra la pagina AR.</div>
    <div class="row">
      <button class="btn primary" id="startBtn">Avvia esperienza</button>
      <button class="btn" id="helpBtn">Come funziona</button>
    </div>
    <div class="sub" style="margin-top:10px;font-size:12.5px;">
      Consiglio: luce buona + pagina ferma 1–2 sec.
    </div>
  </div>
</div>

<a-scene
  mindar-image="imageTargetSrc: targets.mind; autoStart: false; uiLoading: no; uiError: no;"
  embedded
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-assets>
    <!-- Nota: crossorigin aiuta su molte combinazioni browser/CDN -->
    <video id="v1" crossorigin="anonymous"
      src="https://video.wixstatic.com/video/047e10_cbfeceaf5a244d839a6d4fdefa666bda/1080p/mp4/file.mp4"
      preload="auto" playsinline webkit-playsinline muted></video>

    <video id="v2" crossorigin="anonymous"
      src="https://video.wixstatic.com/video/047e10_5741e3a04b2f45c1ab8efe8450641163/1080p/mp4/file.mp4"
      preload="auto" playsinline webkit-playsinline muted></video>

    <video id="v3" crossorigin="anonymous"
      src="https://video.wixstatic.com/video/047e10_68bb22b5292a4047a7ec9bedea327b65/1080p/mp4/file.mp4"
      preload="auto" playsinline webkit-playsinline muted></video>
  </a-assets>

  <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

  <a-entity mindar-image-target="targetIndex: 0">
    <a-plane width="1" height="1" material="shader: flat; src: #v1"></a-plane>
  </a-entity>

  <a-entity mindar-image-target="targetIndex: 1">
    <a-plane width="1" height="1" material="shader: flat; src: #v2"></a-plane>
  </a-entity>

  <a-entity mindar-image-target="targetIndex: 2">
    <a-plane width="1" height="1" material="shader: flat; src: #v3"></a-plane>
  </a-entity>

</a-scene>

<script>
  const ui = document.getElementById("ui");
  const startBtn = document.getElementById("startBtn");
  const helpBtn = document.getElementById("helpBtn");
  const status = document.getElementById("status");
  const page = document.getElementById("page");

  const uiTitle = document.getElementById("uiTitle");
  const uiSub = document.getElementById("uiSub");

  const scene = document.querySelector("a-scene");
  const vids = [
    { el: document.getElementById("v1"), name: "La nostra storia" },
    { el: document.getElementById("v2"), name: "Curiosità & momenti" },
    { el: document.getElementById("v3"), name: "Grazie" }
  ];

  let activeIdx = null;

  function setStatus(text){ status.textContent = "AR " + text; }
  function showPage(name){
    page.classList.remove("hidden");
    page.textContent = "Pagina: " + name;
  }
  function hidePage(){ page.classList.add("hidden"); page.textContent = "Pagina: —"; }

  function stopAll(){
    vids.forEach(v => {
      try { v.el.pause(); v.el.currentTime = 0; } catch(e){}
    });
  }

  async function unlockVideos() {
    // Sblocca la riproduzione come "gesture" (tasto Avvia)
    for (const v of vids) {
      try {
        v.el.muted = true;
        v.el.playsInline = true;
        v.el.setAttribute("playsinline", "");
        v.el.setAttribute("webkit-playsinline", "");
        await v.el.play();
        v.el.pause();
        v.el.currentTime = 0;
      } catch(e) {
        // anche se uno fallisce, continuiamo
      }
    }
  }

  // Pulsante audio: lo mostriamo durante il tracking
  const audioBtn = document.createElement("button");
  audioBtn.className = "btn";
  audioBtn.textContent = "Attiva audio";
  audioBtn.style.position = "fixed";
  audioBtn.style.bottom = "14px";
  audioBtn.style.left = "50%";
  audioBtn.style.transform = "translateX(-50%)";
  audioBtn.style.zIndex = "40";
  audioBtn.style.display = "none";
  document.body.appendChild(audioBtn);

  audioBtn.addEventListener("click", async () => {
    if (activeIdx === null) return;
    const v = vids[activeIdx].el;
    try {
      v.muted = false;
      await v.play();
      audioBtn.textContent = "Audio attivo";
      setTimeout(() => audioBtn.style.display = "none", 800);
    } catch(e){
      // Se blocca, resta muted
      v.muted = true;
      audioBtn.textContent = "Audio non disponibile";
      setTimeout(() => audioBtn.style.display = "none", 1200);
    }
  });

  helpBtn.addEventListener("click", () => {
    alert(
      "1) Tocca 'Avvia esperienza'\n" +
      "2) Consenti la fotocamera\n" +
      "3) Inquadra una pagina AR\n\n" +
      "Se il video non parte subito: più luce e tieni la pagina ferma 1–2 secondi."
    );
  });

  // ✅ PATCH NDA: carica config.json e aggiorna MIND + VIDEO + NOMI (senza cambiare il motore)
  async function loadConfigAndApply() {
    try {
      const res = await fetch("./config.json", { cache: "no-store" });
      if (!res.ok) return;
      const cfg = await res.json();

      // UI text
      if (cfg.title) uiTitle.textContent = cfg.title;
      if (cfg.subtitle) uiSub.textContent = cfg.subtitle;

      // targets.mind configurabile
      if (cfg.targetsMind) {
        scene.setAttribute(
          "mindar-image",
          `imageTargetSrc: ${cfg.targetsMind}; autoStart: false; uiLoading: no; uiError: no;`
        );
      }

      // video src + names
      const map = [
        { id: "v1", idx: 0 },
        { id: "v2", idx: 1 },
        { id: "v3", idx: 2 }
      ];

      map.forEach(({ id, idx }) => {
        const v = document.getElementById(id);
        const t = cfg.targets && cfg.targets[idx];
        if (v && t && t.src) {
          v.src = t.src;
          try { v.load(); } catch(e) {}
        }
        if (t && t.name) {
          vids[idx].name = t.name;
        }
      });

    } catch(e) {
      // Se config non esiste o è errata, non blocchiamo nulla: resta hardcoded
      console.log("Config non caricata:", e);
    }
  }

  // Carica config appena possibile (prima dello start)
  loadConfigAndApply();

  startBtn.addEventListener("click", async () => {
    setStatus("Avvio fotocamera…");
    try {
      // Carica + sblocca i video con gesto utente
      vids.forEach(v => { try { v.el.load(); } catch(e){} });
      await unlockVideos();

      await scene.systems["mindar-image-system"].start();
      ui.style.display = "none";
      setStatus("Inquadra una pagina ✨");
    } catch(e){
      setStatus("Errore fotocamera");
      alert("Non riesco ad avviare la fotocamera. Controlla permessi del browser e riprova.");
    }
  });

  // Events: play MUTED sempre (così non viene bloccato su Android)
  document.querySelectorAll("[mindar-image-target]").forEach((el, i) => {
    el.addEventListener("targetFound", async () => {
      activeIdx = i;
      showPage(vids[i].name);
      setStatus("Contenuto attivo ✨");
      stopAll();

      const v = vids[i].el;
      try {
        v.muted = true;               // fondamentale per autoplay su Android
        await v.play();
        audioBtn.textContent = "Attiva audio";
        audioBtn.style.display = "inline-block"; // se vuoi audio, tap qui (gesture)
      } catch(e){
        // Se non parte nemmeno muted, di solito è encoding non compatibile
        setStatus("Video non avviato");
      }
    });

    el.addEventListener("targetLost", () => {
      if (activeIdx === i) {
        activeIdx = null;
        hidePage();
        setStatus("Inquadra una pagina ✨");
        audioBtn.style.display = "none";
        stopAll();
      }
    });
  });

  setStatus("Pronto ✨");
</script>

</body>
</html>
